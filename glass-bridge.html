<script>
document.addEventListener("DOMContentLoaded", function() {
  let steps = 18,
      current = 0,
      time = 60,
      finished = false;

  let bridge, bridgeContainer, player, bestEl, lastEl, timerInterval, bestTime = localStorage.getItem("bestTime");
  let answers = [];

  // generate or load fixed pattern
  if(localStorage.getItem("glassBridgePattern")){
    answers = JSON.parse(localStorage.getItem("glassBridgePattern"));
  } else {
    answers = Array.from({length:steps}, ()=>Math.floor(Math.random()*2));
    localStorage.setItem("glassBridgePattern", JSON.stringify(answers));
  }

  document.getElementById("startBtn").addEventListener("click", function(){
    document.getElementById("game-container").style.display = "block";

    bridge = document.getElementById("bridge");
    bridgeContainer = document.getElementById("bridgeContainer");
    player = document.getElementById("player");
    bestEl = document.getElementById("best");
    lastEl = document.getElementById("last");

    if(bestTime) bestEl.innerText = bestTime;

    current = 0;
    finished = false;
    time = 60;

    build();

    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
      if(finished) return;
      time--;
      document.getElementById("timer").innerText = "‚è±Ô∏è Time: "+time;
      if(time <= 0){finished=true;alert("‚è∞ TIME UP!");}
    },1000);
  });

  function build(){
    bridge.innerHTML = "";
    for(let i=0; i<steps; i++){
      const row = document.createElement("div");
      row.className = "row";
      for(let j=0; j<2; j++){
        const glass = document.createElement("div");
        glass.className = "glass";
        if(i === current){
          glass.onclick = ()=>choose(j,glass,row);
        } else glass.classList.add("disabled");
        row.appendChild(glass);
      }
      bridge.appendChild(row);
    }
    movePlayerToCurrent();
  }

  function movePlayerToCurrent(){
    const rows = bridge.getElementsByClassName("row");
    if(current < rows.length){
      player.style.top = (rows[current].offsetTop - player.offsetHeight - 5) + "px";
    }
  }

  function choose(choice, glass, row){
    row.querySelectorAll(".glass").forEach(g=>g.classList.add("disabled"));
    document.getElementById("clickSound").play();

    if(choice === answers[current]){
      glass.classList.add("safe");
      current++;
      movePlayerToCurrent();
      if(current === steps) win();
      else setTimeout(build, 300);
    } else {
      glass.classList.add("broken");
      player.style.transform += " rotate(90deg)";
      player.style.opacity = "0";
      gameOver();
    }
  }

  function win(){
    finished = true;
    document.getElementById("winSound").play();
    const used = 60 - time;
    lastEl.innerText = used;
    if(!bestTime || used < bestTime){
      localStorage.setItem("bestTime", used);
      bestEl.innerText = used;
      bestTime = used;
    }
    setTimeout(()=>alert("üèÜ YOU SURVIVED!"),300);
  }

  function gameOver(){
    finished = true;
    document.getElementById("breakSound").play();
    lastEl.innerText = "--";
    setTimeout(()=>alert("üí• GAME OVER"),300);
  }

  window.resetBest = function(){
    localStorage.removeItem("bestTime");
    bestEl.innerText = "--";
    bestTime = null;
  }
});
</script>
